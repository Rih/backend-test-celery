{% extends "base-admin.html" %}
{% load i18n %}
{% block content %}

{% block custom_head %}

<style>

.sweet-overlay{z-index:5000!important;}
.sweet-alert{z-index:5001!important;}

</style>
{% endblock custom_head %}
<div id="create_container"></div>
<div id="edit_container"></div>
<div id="wrapper">
    <div class="container-fluid">
        <h1 class="h3 mb-2 text-gray-800">My Meals</h1>
        <div class="row">
            <div class="col-lg-12 mb-4">
                 <button class="btn btn-success float-right" onClick="prepareModal({model: 'meal',mode: 'create', modal_container: 'create_container'}, 0)">Create</button>
             </div>
        </div>
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">{% trans "all_meals" %}</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tfoot>
                            <tr>
                                <th>Title</th>
                                <th>Action</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}
  {% block js %}
    <script>
        function escapeRegExp(str) {
            return str.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
        }
        function replaceAll(str, find, replace) {
            return str.replace(new RegExp(escapeRegExp(find), 'g'), replace);
        }
        const str = "{{ partial_names|safe }}";
        const partials = JSON.parse(replaceAll(str, "'", "\""));
        const BASE_URL = '{{ base_url }}';
        var TABLE = $('#dataTable');
        var TABLE_RENDERED;

        function openModal(url, params){
            const { modal_container, mode } = params;
            $.ajax(
                {
                    url: url,
                    method: 'GET',
                }
            ).done((result, xhr, x2) => {
                console.log(result);
                $(`#${modal_container}`).html(result);
                $(`#${partials[mode].modal_id}`).modal('show');
                addCreateEditListener(mode);
                modalOnClose(partials[mode].modal_id);

            }).fail((result, xhr, x2) => {
                Swal.fire({
                  title: 'Modal failed!',
                  text: 'Error desconocido',
                  icon: 'error',
                });
            });
        }


        function prepareModal(params, mealId = 0){
            const query = new URLSearchParams(params).toString();
            const url = `${BASE_URL}/dashboard/meals/${params.mode}/${mealId}/?${query}`;
            openModal(url, {
                modal_container: params.modal_container,
                model_name: params.model,
                mode: params.mode,
            });
        }

        function saveMeal(event, mode, modal_container){
            event.preventDefault();
            const modelId = $(event.target).data('modelId');
            const url = (modelId) ? `${BASE_URL}/api/meals/${modelId}/` : `${BASE_URL}/api/meals/`;
            const form = $(event.target);
            const data = form.serialize();
            const request = $.ajax(
                {
                    url: url,
                    method: (modelId) ? 'PUT': 'POST',
                    dataType: 'json',
                    data: JSON.stringify(data),
                }
            );
            request.done( async(result) => {
                console.log(result);
                await Swal.fire({
                  title: 'Action successful!',
                  text: 'OK!',
                  icon: 'success',
                });
                $(`#${partials[mode].modal_id}`).modal('hide');
                $(`#${modal_container}`).html('');
                $(".modal-backdrop").remove();
                $("#page-top").removeClass("modal-open");
                unbindTableEventListener();
                TABLE_RENDERED.ajax.reload();
            });
            request.fail((result, xhr, x2) => {
                const res = JSON.parse(result.responseText);
                if (result.status != 200){
                    Swal.fire({
                      title: 'Record failed!',
                      text: res.detail,
                      icon: 'error',
                      allowOutsideClick: false,
                      allowEscapeKey: false,
                    });
                }

            });
        }

         async function deleteMeal(mealId){
            const { isConfirmed } = await Swal.fire({
              title: 'Deletion!',
              text: 'Do you want to continue',
              icon: 'warning',
              confirmButtonText: 'Yes!'
            });
            const url = `${BASE_URL}/api/meals/${mealId}/`;
            if (isConfirmed){
                $.ajax(
                    {
                        url: url,
                        method: 'DELETE',
                        dataType: 'application/json',
                    }
                ).done(async (result, xhr, x2) => {
                    if(x2.status == 204){
                        //refresh table
                        await Swal.fire({
                          title: 'Deletion successful!',
                          text: 'OK!',
                          icon: 'success',
                          allowOutsideClick: false,
                          allowEscapeKey: false,
                        });
                        unbindTableEventListener();
                        TABLE_RENDERED.ajax.reload();
                    }
                }).fail((result, xhr, x2) => {
                    const res = JSON.parse(result.responseText)
                    Swal.fire({
                      title: 'Deletion failed!',
                      text: res.detail,
                      icon: 'error',
                      allowOutsideClick: false,
                      allowEscapeKey: false,
                    });
                });
            }

        }
        $(document).ready(function(){
            createTable();

        });

        function modalOnClose(modalId){
            $(`#${modalId}`).on('hidden.bs.modal', function (e) {
                // do something when this modal window is closed...
                $(".modal-backdrop.fade.show").remove();
            });
        }

        function renderEditBtn(id){
            return `<button class="btn btn-primary edit-btn" data-modelId="${id}">
                <i class="fa fa-edit" aria-hidden="true" data-rowid="${id}"></i>
            </button>`
        }
        function renderDeleteBtn(id){
            return `<button class="btn btn-danger delete-btn" data-modelId="${id}">
                <i class="fa fa-trash" aria-hidden="true" data-rowid="${id}"></i>
            </button>`
        }

        function addCreateEditListener(mode){
            $(`#${partials[mode].form_id}`).on("submit", function(e){
                saveMeal(e, mode, `${mode}_container`);
            });
        }

        function bindTableEventListener(){
            $("button.edit-btn").on('click', (event) => {
                prepareModal(
                    {model: 'meal',mode: 'edit', modal_container: 'edit_container'},
                    $(event.target).data('modelid')
                 )
            });
            $("button.delete-btn").on('click', (event) => {
                deleteMeal($(event.target).data('modelid'))
            });
        }

        function unbindTableEventListener(){
            $("body").off("click", ".edit-btn");
            $("body").off("click", ".delete-btn");
        }

        function createTable(){
            const url = `${BASE_URL}/api/meals/`;
            TABLE_RENDERED = TABLE.DataTable({
                "ajax": {
                    "url": url,
                    "dataType": "json",
                    "cache": false,
                    "dataSrc": ""
                },
                "columns": [
                    {
                        data: 'Title',
                        render: function(data, type, row, meta){
                            return row.title
                        }
                    },
                    {
                        data: 'Action',
                        render: function(data, type, row, meta){
                            const editBtn = renderEditBtn(row.id);
                            const deleteBtn = renderDeleteBtn(row.id);
                            return `${editBtn} &nbsp; ${deleteBtn}`
                        }
                    },
                ],
                'searching': true,
                "destroy": true,
                "pagination": true,
                "bPaginate": false,
                "formatNumber": function ( toFormat ) {
                    return toFormat.toString().replace(
                        /\B(?=(\d{3})+(?!\d))/g, "'"
                        );
                },
                "bLengthChange": false,
                "order": [[ 0, "desc" ]],
                "autoWidth": false,
                "drawCallback": function( settings ) {
                    bindTableEventListener();
                }
            });
        }
    </script>
  {% endblock js %}

</body>
</html>